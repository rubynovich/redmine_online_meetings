%div
  %iframe{:height => "484", :src => Setting[:plugin_redmine_online_meetings][:videoserver_nginx_proxy] == "1" ? "/videoserver/#{26000+@object.server_id}/vncrun.html?host=#{Setting[:plugin_redmine_online_meetings][:videoserver_host]}&port=#{26000+@object.server_id}&password=12345678" : "https://#{Setting[:plugin_redmine_online_meetings][:videoserver_host]}:#{26000+@object.server_id}/vncrun.html?host=#{Setting[:plugin_redmine_online_meetings][:videoserver_host]}&port=#{26000+@object.server_id}&password=12345678", :width => "640"}
%div
  = link_to("&#9632; #{l(:link_to_stop_record_hangouts)}".html_safe, stop_record_meeting_agenda_path(@object), style: 'display: block; width: 170px; height: 20px; font-weight: bold; font-size: 14px; background: #F00; border-radius: 4px; padding: 10px; color: #FFF;')
:javascript
  var continue_time = #{Setting[:plugin_redmine_online_meetings][:continue_time]}
  var timeout = #{Setting[:plugin_redmine_online_meetings][:timeout]}
  var cont_to = function(minutes, stop_time) {
    setTimeout(function(){
      var current_time = parseInt(new Date().getTime() / 1000);
      var add_minutes = null;
      console.log({
        timeout: timeout,
        current_time: current_time,
        continue_time: #{Setting[:plugin_redmine_online_meetings][:continue_time].to_i},
        continue_time_notify: #{Setting[:plugin_redmine_online_meetings][:continue_time_notify]}
      })
      if ((current_time+#{((Setting[:plugin_redmine_online_meetings][:continue_time_notify] || 0).to_i) * 60 }) < stop_time){
        add_minutes = timeout;
        console.log('timeout +');
      } else {
        add_minutes = false;
        add_minutes = parseInt(prompt('#{l(:prompt_continue_time)}', timeout));
      }
      if (add_minutes){
        $.post('#{continue_record_meeting_agenda_path(@object)}', { continue_time: continue_time },function( data ){
          if (#{Setting[:plugin_redmine_online_meetings][:continue_time_notify] || 0} > 0){
            cont_to(1, data.stop_time);
          }
        },"json");
      }
      var timeout2 = (stop_time - parseInt(new Date().getTime() / 1000)) * 1000;
      if (timeout2 < 1){ timeout2 = 1; }
      setTimeout(function(){
        $.get('#{stop_record_meeting_agenda_path(@object)}', function(){
          alert('#{l(:notify_stop_recording)}');
        })
      }, timeout2 );

    }, minutes*60000)
  }

  var stop_time = #{@object.end_time_utc.to_i}
  cont_to(1, stop_time);
  console.log('starting record');

